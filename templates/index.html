<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beküldő felület</title>
    <style>
        /* --- ALAPBEÁLLÍTÁSOK --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            color: #333;
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }

        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
        }

        /* --- INPUTOK ÉS GOMBOK --- */
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0 20px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button, input[type="submit"] {
            width: auto;
            min-width: 100px;
            background-color: #e6f2ff;
            color: #222222;
            border: 1px solid #b3d7ff;
            padding: 10px 20px;
            margin-top: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        button:hover, input[type="submit"]:hover {
            background-color: #cfe6ff;
            border-color: #99caff;
        }

        /* --- ÚJRAKEZDÉS GOMB (SÁRGA) --- */
        .btn-restart {
            background-color: #fff9c4; /* Halvány sárga háttér */
            border-color: #fbc02d;     /* Sötétebb sárga/okker keret */
            color: #000000;            /* Fekete szöveg */
        }

        .btn-restart:hover {
            background-color: #fff59d; /* Kicsit sötétebb sárga, ha ráviszed az egeret */
            border-color: #f9a825;
        }

        /* --- LÁBLÉC --- */
        .footer {
            margin-top: 40px;
            padding-top: 15px;
            border-top: 1px solid #eeeeee;
            text-align: center;
            font-size: 13px;
            color: #888888;
        }

        .footer a {
            color: #666666;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .footer a:hover {
            color: #007bff;
            text-decoration: underline;
        }

        /* --- JÁTÉKVÁLASZTÓ LISTA STÍLUSOK (ÚJ) --- */

        /* A "Válassz játékot" felirat stílusa */
        .game-select-title {
            text-align: left;
            font-size: 16px;
            margin-bottom: 10px;
            color: #555;
        }

        /* A görgethető lista doboza */
        #games-list-container {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fafafa;
            margin-bottom: 15px;
        }

        /* Üzenet, ha üres a lista vagy tölt */
        .game-list-message {
            padding: 10px;
            color: #888;
            text-align: center;
        }

        /* Egy játék sorának stílusa (label) */
        .game-option-label {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .game-option-label:hover {
            background-color: #f0f8ff;
            border-radius: 4px;
        }

        /* A rádiógomb stílusa */
        .game-option-input {
            width: auto;
            margin: 0 10px 0 0;
        }

        /* A játék nevének stílusa */
        .game-option-name {
            font-weight: 500;
        }

        /* Rejtett elemek */
        .hidden {
            display: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Turing-teszt</h1>

        {% if game %}
            <form action="/" method="post">
                <input type="hidden" name="is_admin" value="{{ is_admin }}">

                <button type="submit" name="action" value="restart" class="btn-restart" onclick="return confirm('Biztosan kilépsz a főmenübe? A jelenlegi játék állása elveszhet.')">
                    Újrakezdés (Kilépés a menübe)
                </button>
            </form>
        {% else %}
            {% if is_admin %}
                <form action="/" method="post">
                    <input type="hidden" name="is_admin" value="False">
                    <button type="submit" name="action" value="make_nonadmin">Játékos módba lép</button>
                </form>
            {% else %}
                <form action="/" method="post">
                    <input type="hidden" name="is_admin" value="True">
                    <button type="submit" name="action" value="make_nonadmin">Admin módba lép</button>
                </form>
            {% endif %}
        {% endif %}
        <hr>

        {% if game %}

            {% if is_admin %}
                <p>Kód: {{ game }}</p>
            {% endif %}

            {% if prompt %}
                <p>Prompt: {{prompt}}</p>
            {% endif %}

            {% if is_admin %}
                {% if not is_final %}
                    <form action="/" method="post">
                        <input type="hidden" name="game" value={{ game }}>
                        <input type="hidden" name="is_admin" value={{ is_admin }}>
                        <button type="submit" name="action" value="finalize" onclick="return confirm('Biztosan véglegesíteni szeretnéd?')">Véglegesít</button>
                    </form>
                {% endif %}
                <h2>Beküldött mondatok:</h2>
                <ul id="sentences-list">
                    {% for sentence in sentences %}
                        <li>{{ sentence[0] }}</li>
                    {% endfor %}
                </ul>

                {% if not is_final %}
                    <p><i>Várakozás a válaszokra... (az oldal automatikusan frissül)</i></p>
                {% endif %}
                <hr>
            {% endif %}

            {% if is_final %}
                <p>A játszma véglegesítve lett.<p>
            {% endif %}

            {% if not is_admin %}

                {% if is_final %}
                    {% if guessed %}
                        <p>Tipp eredmány: {{ message }}</p>
                    {% else %}
                        <form action="/" method="post">
                            <input type="hidden" name="game" value={{ game }}>
                            <input type="hidden" name="is_admin" value={{ is_admin }}>

                            {% for sentence in sentences %}
                                <input type="radio" name="guess" value={{ sentence[1] }}>
                                <label for="html">{{ sentence[0] }}</label><br>
                            {% endfor %}

                            <button type="submit" name="action" value="guess">Tippel</button>
                        </form>
                    {% endif %}

                {% elif message %}
                    <p>{{ message }}</p>
                    <p><b>Kérlek várj, amíg a Játékmester lezárja a kört...</b></p>
                    <div class="hidden">
                        <form action="/" method="post">
                            <input type="hidden" name="game" value={{ game }}>
                            <input type="hidden" name="is_admin" value={{ is_admin }}>
                            <button type="submit" name="action" value="continue">Folytat</button>
                        </form>
                    </div>
                {% else %}
                    <form action="/" method="post">
                        <input type="hidden" name="game" value={{ game }}>
                        <input type="hidden" name="is_admin" value={{ is_admin }}>
                        <input type="text" name="sentence" size="50" placeholder="Írj egy meghatározást (legalább 3, legfeljebb 5 szó)...">
                        <button type="submit" name="action" value="submit">Beküld</button>
                    </form>
                {% endif %}

            {% endif %}

        {% else %}
            {% if message %}
                <p>{{ message }}</p>
            {% endif %}

            {% if is_admin %}
                <form action="/" method="post">
                    <input type="hidden" name="is_admin" value={{ is_admin }}>
                    <input type="checkbox" name="is_custom_prompt" id="is_custom_prompt" onclick="document.getElementById('custom_prompt_fields').hidden=!document.getElementById('is_custom_prompt').checked"><span>Saját prompt megadása</span><br>
                    <div id="custom_prompt_fields" hidden>
                        <input type="text" name="custom_prompt" size="50" placeholder="Saját prompt"><br>
                        <input type="text" name="custom_answer" size="50" placeholder="Saját válasz">
                    </div>
                    <br><button type="submit" name="action" value="generate">Kódot generál</button>
                </form>
            {% else %}
                <form action="/" method="post">
                    <input type="hidden" name="is_admin" value="{{ is_admin }}">

                    <h3 class="game-select-title">Válassz játékot:</h3>

                    <div id="games-list-container">
                        <div class="game-list-message">Játékok keresése...</div>
                    </div>

                    <button type="submit" name="action" value="setcode">Csatlakozás a kiválasztotthoz</button>
                </form>

                <script>
                    function updateGameList() {
                        fetch('/list_games')
                            .then(response => response.json())
                            .then(games => {
                                const container = document.getElementById('games-list-container');

                                const currentSelection = document.querySelector('input[name="game"]:checked')?.value;

                                if (games.length === 0) {
                                    // Inline style helyett class
                                    container.innerHTML = '<div class="game-list-message">Nincs aktív játék jelenleg.</div>';
                                    return;
                                }

                                let html = '';
                                games.forEach(g => {
                                    const isChecked = (g.id == currentSelection) ? 'checked' : '';

                                    // Itt a generált HTML-ben is class-okat használunk style helyett
                                    html += `
                                    <label class="game-option-label">
                                        <input type="radio" name="game" value="${g.id}" ${isChecked} required class="game-option-input">
                                        <span class="game-option-name">${g.name}</span>
                                    </label>`;
                                });

                                container.innerHTML = html;
                            })
                            .catch(err => console.error("Hiba a lista frissítésekor:", err));
                    }

                    updateGameList();
                    setInterval(updateGameList, 3000);
                </script>
            {% endif %}

        {% endif %}

        {% if game %}
        <script>
            const gameId = "{{ game }}";
            const isAdmin = {{ 'true' if is_admin else 'false' }};
            let currentSentenceCount = {{ sentences|length }};
            let isFinal = {{ 'true' if is_final else 'false' }};

            setInterval(function() {
                if (!isAdmin && isFinal) return;

                fetch('/get_game_status?game=' + gameId)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        const reloadWithState = () => {
                            window.location.href = "/?game=" + gameId + "&is_admin=" + (isAdmin ? 'True' : 'False');
                        };

                        if (isAdmin) {
                            if (data.sentence_count > currentSentenceCount) {
                                console.log("Új válasz érkezett, frissítés...");
                                reloadWithState();
                            }
                        } else {
                            if (data.is_final === true && isFinal === false) {
                                console.log("A játék lezárult, frissítés a tippeléshez...");
                                reloadWithState();
                            }
                        }
                    }
                })
                .catch(error => console.error('Hiba:', error));
            }, 2000);
        </script>
        {% endif %}
        <div class="footer">
            A játék kitalálója és megalkotója: <a href="http://faragocsaba.hu" target="_blank">Faragó Csaba</a>
        </div>
    </div>
</body>
</html>